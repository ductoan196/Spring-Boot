<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout_dashboard_partner :: main-fragment(
                                                ~{:: title},
                                                ~{:: #css-resources},
                                                ~{:: #js-resources},
                                                ~{:: #main-content}
                                               )}">

<head>

    <title>Partner Dashboard</title>

    <th:block id="css-resources">

    </th:block>
</head>

<body>

<main id="main-content">
    <div class="page-content">

        <div class="row">
            <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h4 class="mb-4">Hotel Information</h4>
                        <div class="container">
                            <div class="row my-t bs">
                                <div class="col d-flex justify-content-center">
                                    <img id="avatar-hotel" class="rounded-circle" style="width: 150px; height: 150px"
                                         alt="Avatar"
                                         src="/assets/user/images/default-hotel.jpg"/>

                                </div>
                                <div class="row mt-2 mx-0">
                                    <div class="col d-flex justify-content-center">
                                        <button class="btn btn-sm change-avatar-hotel" style="border: 0.5px solid grey">
                                            <i class="link-icon p-1" data-feather="upload"></i> Upload avatar
                                        </button>
                                        <button class="btn btn-sm btn-success submit-avatar-btn ml-1" hidden="hidden">
                                            Save
                                        </button>
                                    </div>
                                </div>

                            </div>
                            <form class="forms-sample mt-3" id="uploadForm">
                                <div class="row">
                                    <input type="file" hidden="hidden" id="avatar-input-hotel"/>
                                    <div class="col-lg-6 mb-3">
                                        <label for="name" class="form-label"> Full Name *</label>
                                        <input type="text" class="form-control" id="name" autocomplete="off"
                                               placeholder name="name">
                                    </div>
                                    <div class="col-lg-6 mb-3">
                                        <label for="email" class="form-label">Email Address *</label>
                                        <input type="email" class="form-control" id="email" autocomplete="off"
                                               placeholder name="email">
                                    </div>
                                    <div class="col-lg-6 mb-3">
                                        <label for="phone" class="form-label">Phone No. *</label>
                                        <input type="number" class="form-control" id="phone" autocomplete="off"
                                               placeholder name="phone">
                                    </div>

                                    <div class="col-lg-6 mb-3">
                                        <label for="address" class="form-label"> Address *</label>
                                        <input type="text" class="form-control" id="address" autocomplete="off"
                                               placeholder name="address">
                                    </div>


                                </div>
                            </form>

                            <div class="text-right pt-4">
                                <button type="submit" class="btn btn-primary submit-hotel-profile-btn"
                                        id="submit-hotel-profile-btn"><i class="link-icon"
                                                                         data-feather="save"></i> Save Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<th:block id="js-resources">
    <script src="assets/user/js/modify-profile.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"
            integrity="sha512-rstIgDs0xPgmG6RX1Aba4KV5cWJbAMcvRCVmglpam9SoHZiUCyQVDdH2LPlxoHtrv17XWblE/V/PP+Tr04hbtA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        $(document).ready(function () {
            let userInfo = JSON.parse(localStorage.getItem("userInfo"))
            let emailInput = document.getElementById('email');
            let nameInput = document.getElementById('name');
            let phoneInput = document.getElementById('phone');
            let addressInput = document.getElementById('address');
            let avatarInput = document.getElementById('avatar-hotel')

            const btnSubmit = document.getElementById('submit-hotel-profile-btn');

            emailInput.value = userInfo.username;
            emailInput.readOnly = true;

            getHotelByEmail();

            function getHotelByEmail() {
                const jwt = localStorage.getItem('jwt');
                let emailHotel = userInfo.username
                if (jwt) {
                    $.ajax({
                        url: `/api/v1/partner/hotel?email=${encodeURIComponent(emailHotel)}`,
                        type: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + jwt
                        },
                        success: function (response) {
                            // Xử lý dữ liệu khách sạn nhận được từ response
                            console.log(response);
                            // Hiển thị thông tin khách sạn trong giao diện
                            nameInput.value = response.name;
                            phoneInput.value = response.phone;
                            addressInput.value = response.address;
                            // avatarInput.src = response.imageUrl;
                            if (response.imageUrl !== null && response.imageUrl !== "") {
                                avatarInput.src = response.imageUrl;
                            }

                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                        }
                    });
                }
            }

            $("#uploadForm").validate({
                onfocusout: false,
                onkeyup: false,
                onclick: false,
                rules: {
                    "name": {
                        required: true,
                        maxlength: 100
                    },
                    "phone": {
                        required: true,
                        minlength: 10,
                        maxlength: 15,
                        digits: true
                    },
                    "address": {
                        required: true,
                        maxlength: 500
                    }
                },
                messages: {
                    "name": {
                        required: "Please enter the hotel name.",
                        maxlength: "The hotel name must not exceed 100 characters."
                    },
                    "phone": {
                        required: "Please enter the phone number.",
                        minlength: "Phone number must be at least 10 digits.",
                        maxlength: "Phone number must not exceed 15 digits.",
                        digits: "Please enter a valid phone number with digits only."
                    },
                    "address": {
                        required: "Please enter the hotel address.",
                        maxlength: "The address must not exceed 500 characters."
                    }
                },
                errorClass: "custom-error-message"
            });


            // toastr.options.timeOut = 2500; // 2.5s
            let chosenFile = null;

            $(".change-avatar-hotel").click(() => {
                $("#avatar-input-hotel").click();
            });

            $("#avatar-input-hotel").change(event => {
                const tempFiles = event.target.files;
                if (!tempFiles || tempFiles.length === 0) {
                    return;
                }
                console.log(event.target.files[0].data);
                chosenFile = tempFiles[0];

                const imageBlob = new Blob([chosenFile], {type: chosenFile.type});
                const imageUrl = URL.createObjectURL(imageBlob);
                $("#avatar-hotel").attr("src", imageUrl);
            });

            btnSubmit.addEventListener('click', function () {
                if ($("#uploadForm").valid()) {
                    const formData = new FormData();
                    formData.append('file', chosenFile);
                    formData.append('name', nameInput.value);
                    formData.append('phone', phoneInput.value);
                    formData.append('address', addressInput.value);
                    formData.append('email', emailInput.value);

                    console.log(JSON.stringify(formData))
                    $.ajax({
                        url: '/api/v1/partner/hotel',
                        data: formData,
                        type: 'PUT',
                        contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
                        processData: false, // NEEDED, DON'T OMIT THIS
                        success: function (data) {
                            toastr.success("Update thông tin khách sạn thành công")
                            console.log(data);
                            window.location.reload();
                        },
                        error: function (errorData) {
                            console.log(errorData);
                            toastr.error("Vui lòng điền đầy đủ thông tin bắt buộc");
                        }
                    });
                }
            });

        });
    </script>
</th:block>
</body>

</html>